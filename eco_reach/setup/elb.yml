---
 - name: Ec2 facts
   local_action: 
     module: ec2_remote_facts
     #aws_access_key: "{{ lookup('env','AWS_ACCESS_KEY_ID') }}"
     #aws_secret_key: "{{ lookup('env','AWS_SECRET_ACCESS_KEY') }}"
     region: "{{ ec2_region }}"
     filters:
      instance-state-name: running
      'tag:Stack': "{{ rgn }}-{{ env }}-{{ app }}"
   register: ec2_info

 - name: add the webservers to the load balancer
   local_action: ec2_elb
   args:
     instance_id: "{{ item.id }}"
     ec2_elbs: "{{ rgn }}-{{ env }}-{{ app }}"
     state: present
     region: "{{ ec2_region }}"
   with_items: "{{ ec2_info.instances }}"
