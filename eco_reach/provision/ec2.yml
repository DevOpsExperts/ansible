---
 - name: Provision a set of instances
   ec2:
     key_name: "{{ ec2_key_name }}" 
     group: "{{ ec2_group }}" 
     instance_type: "{{ ec2_instance_type }}" 
     image: "{{ ec2_image }}" 
     wait: true
     instance_tags: 
       Name: "{{ rgn }}-{{ env }}-{{ app }}"
       Stack: "{{ rgn }}-{{ env }}-{{ app }}"
     exact_count: "{{ ec2_exact_count }}"
     count_tag: 
       Stack: "{{ rgn }}-{{ env }}-{{ app }}"
     region: "{{ ec2_region }}" 
     zone: "{{ ec2_zone }}" 
   register: ec2

 - name: wait for the servers to appear on the network
   wait_for: host={{ item.private_ip }} port=22 delay=3 timeout=180 state=started search_regex=OpenSSH
   with_items: "{{ ec2.tagged_instances }}"

